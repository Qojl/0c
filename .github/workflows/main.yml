name: Publish HiHello to PyPI

# 手動トリガーも可能
on:
  workflow_dispatch: {}   # 手動起動用
  push:
    tags:
      - 'v*'  # タグ push でも自動実行

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      # コード取得
      - name: Checkout code
        uses: actions/checkout@v3

      # Python環境構築
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # pip とビルドツールのインストール
      - name: Upgrade pip and install tools
        run: |
          python -m pip install --upgrade pip
          pip install build twine pytest

      # ローカルで editable インストール
      - name: Install package
        run: pip install -e .

      # 確認用 Python パス
      - name: Verify Python path
        run: python -c "import sys; print(sys.path)"

      # テスト実行（強制起動でも安定）
      - name: Run tests
        working-directory: ${{ github.workspace }}
        run: |
          export PYTHONPATH=$PYTHONPATH:${GITHUB_WORKSPACE}
          pytest tests/ -v

      # ビルド
      - name: Build package
        run: python -m build

      # PyPI公開
      - name: Publish to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_KEY }}
        run: python -m twine upload dist/*
